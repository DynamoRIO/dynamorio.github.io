---
title: "Sample Tools"
layout: default
permalink: /API_samples.html
---
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Sample Tools </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>We provide several examples in the <code>samples</code> directory of the release package to illustrate how the DynamoRIO API is used to build a DynamoRIO client.</p>
<p>There are also samples for the Dr. Memory Framework located in the <code>drmemory/drmf/samples</code> directory of the release package.</p>
<p>For larger examples of clients, see the provided <a class="el" href="page_tool.html">Available Tools</a>, which are larger and more polished end-user clients than these samples.</p>
<h1><a class="anchor" id="sample_list"></a>
List of Samples</h1>
<p>Each sample below is in the <code>api/samples</code> directory. The links point to the corresponding source file in the Git repository.</p>
<h2><a class="anchor" id="sec_sample_bbbuf"></a>
bbbuf.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/bbbuf.c">bbbuf.c</a> records each basic block’s start PC into a per-thread fast circular buffer (default 64KB) by inserting inline instrumentation at the first instruction of each basic block using the drx_buf extension. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>TLS-backed per-thread buffers via <a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> (Buffer Filling API) </li>
<li>Basic block instrumentation at block entry </li>
<li>Scratch register management with <a class="el" href="page_drreg.html">Register Management</a> </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Hot path profiling based on basic block history </li>
<li>Lightweight execution tracing for debugging</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_bbcount"></a>
bbcount.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/bbcount.c">bbcount.c</a> counts dynamic basic block executions by inserting a non-atomic global counter update at the start of each basic block using <a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> counter helpers. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Basic block instrumentation </li>
<li>Inline counter updates with <a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> </li>
<li>AFLAGS liveness checks via <a class="el" href="page_drreg.html">Register Management</a> </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Measuring overall execution volume </li>
<li>Comparing workloads by basic block activity</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_bbsize"></a>
bbsize.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/bbsize.c">bbsize.c</a> computes the number, maximum size, and average size of basic blocks using a basic-block analysis callback and explicit floating-point state save/restore. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Basic block analysis callbacks </li>
<li>Floating-point state preservation in callbacks </li>
<li>Shared statistics protected by a mutex </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Characterizing code layout behavior </li>
<li>Comparing compiler output across binaries</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_callstack"></a>
callstack.cpp</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/callstack.cpp">callstack.cpp</a> wraps a configurable function (default: malloc) and prints a symbolized call stack on each call using <a class="el" href="page_drwrap.html">Function Wrapping and Replacing Extension</a>, <a class="el" href="page_drcallstack.html">Callstack Walking</a>, and <a class="el" href="page_drsyms.html">Symbol Access Library</a>. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Function wrapping with <a class="el" href="page_drwrap.html">Function Wrapping and Replacing Extension</a> </li>
<li>Call stack walking via the <a class="el" href="page_drcallstack.html">Callstack Walking</a> extension </li>
<li>Symbol lookup with <a class="el" href="page_drsyms.html">Symbol Access Library</a> </li>
<li>Runtime options via <a class="el" href="page_droption.html">DynamoRIO Option Parser</a> </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Debugging unexpected call paths </li>
<li>Capturing stack traces at selected points</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_cbr"></a>
cbr.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/cbr.c">cbr.c</a> instruments conditional branches with separate taken/not-taken clean calls, records which edges execute, and flushes and redirects execution to remove instrumentation during execution once each edge has been seen. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Conditional branch instrumentation with clean calls </li>
<li>Fragment flushing and execution redirection </li>
<li>Per-branch state tracking with a hash table </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Building dynamic control-flow graphs </li>
<li>Reducing overhead after edge discovery</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_cbrtrace"></a>
cbrtrace.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/cbrtrace.c">cbrtrace.c</a> logs each conditional branch’s address, fall-through, target, and taken direction to per-thread log files using <a class="el" href="dr__ir__utils_8h.html#aaf70b54e0f62baf2a7bfe3b13b55c579">dr_insert_cbr_instrumentation_ex()</a>. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Conditional branch instrumentation </li>
<li>Thread-local storage via drmgr TLS fields (<a class="el" href="page_drmgr.html">Multi-Instrumentation Manager</a>) </li>
<li>Per-thread log file output </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Debugging branch behavior </li>
<li>Building branch outcome traces</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_countcalls"></a>
countcalls.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/countcalls.c">countcalls.c</a> counts dynamic direct calls, indirect calls, and returns using per-thread TLS data and inline counter updates with flag preservation. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>TLS-based per-thread data via drmgr (<a class="el" href="page_drmgr.html">Multi-Instrumentation Manager</a>) </li>
<li>Instruction classification for calls and returns </li>
<li>Inline counter updates with <a class="el" href="page_drreg.html">Register Management</a> </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Profiling call/return behavior </li>
<li>Comparing indirect call frequency across inputs</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_div"></a>
div.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/div.c">div.c</a> counts unsigned division instructions and how often the runtime divisor is a power of two, using a clean call to read the divisor value. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Clean calls for operand inspection </li>
<li>Runtime operand value extraction </li>
<li>Thread-safe counters with a mutex </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Identifying optimization opportunities </li>
<li>Finding expensive divisions in hot code</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_empty"></a>
empty.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/empty.c">empty.c</a> is a minimal client that only registers an exit event and performs no instrumentation. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Client initialization </li>
<li>Exit event handling </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Starting point for new clients </li>
<li>Verifying build and load pipelines</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_hot_bbcount"></a>
hot_bbcount.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/hot_bbcount.c">hot_bbcount.c</a> uses <a class="el" href="page_drbbdup.html">Basic Block Duplicator</a> to create cold and hot versions of basic block instrumentation, switching to inline counter updates after a per-block hit threshold is reached. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Basic block duplication (<a class="el" href="page_drbbdup.html">Basic Block Duplicator</a>) </li>
<li>Clean calls versus inline counter updates </li>
<li>Runtime case encoding stored in raw TLS </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Hot path profiling with reduced overhead </li>
<li>Tiered instrumentation strategies</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_inc2add"></a>
inc2add.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/inc2add.c">inc2add.c</a> performs an app2app transformation that replaces inc/dec with add/sub in trace blocks when the carry flag is not live, using drreg liveness analysis to preserve correctness. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>App2app transformations </li>
<li>Instruction replacement </li>
<li>Flag liveness checks with <a class="el" href="page_drreg.html">Register Management</a> </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Exploring micro-architecture-specific optimizations </li>
<li>Testing transformation pipelines</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_inline"></a>
inline.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/inline.c">inline.c</a> customizes trace formation to inline callees into traces by marking call sites as trace heads and ending traces after returns or size limits. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Custom trace control via end-trace events </li>
<li>Trace head tracking with <a class="el" href="page_drmgr.html">Multi-Instrumentation Manager</a> and <a class="el" href="dr__tools_8h.html#a15aa23aae4a1d322fbe0a1cffedbaf3a">dr_mark_trace_head()</a> </li>
<li>Fragment lifecycle handling on deletion </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Dynamic inlining experiments </li>
<li>Trace-level performance research</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_inscount"></a>
inscount.cpp</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/inscount.cpp">inscount.cpp</a> counts executed instructions by computing per-basic-block instruction counts in analysis and adding them via an auto-inlined clean call, with an option to count only application code. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Clean calls optimized by DynamoRIO </li>
<li>Runtime options via <a class="el" href="page_droption.html">DynamoRIO Option Parser</a> </li>
<li>Emulation-aware instruction counting with drmgr (<a class="el" href="page_drmgr.html">Multi-Instrumentation Manager</a>) </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Instruction count profiling </li>
<li>Validating instrumentation overhead</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_instrace_simple"></a>
instrace_simple.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/instrace_simple.c">instrace_simple.c</a> records a per-thread instruction trace (PC and opcode) into a raw TLS buffer with inline instrumentation and flushes it to a text file using clean calls. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Raw TLS buffer management </li>
<li>Inline per-instruction instrumentation </li>
<li>Clean calls to flush per-thread buffers </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Building simple instruction traces </li>
<li>Validating instrumentation correctness </li>
<li>For a full-featured instruction and data address tracing tool, see <a class="el" href="page_drcachesim.html">Tracing and Analysis Framework</a>.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_instrace_x86"></a>
instrace_x86.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/instrace_x86.c">instrace_x86.c</a> captures a per-thread instruction trace on x86 using inline buffer filling and a local code cache for lean clean calls when the buffer fills. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Local code cache generation </li>
<li>Lean clean calls </li>
<li>Per-thread buffering and file output </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>High-performance instruction tracing </li>
<li>Producing binary traces for offline analysis </li>
<li>For a full-featured instruction and data address tracing tool, see <a class="el" href="page_drcachesim.html">Tracing and Analysis Framework</a>.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_instrcalls"></a>
instrcalls.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/instrcalls.c">instrcalls.c</a> logs each direct call, indirect call, and return with target information to per-thread files, with optional symbolization via drsyms (<a class="el" href="page_drsyms.html">Symbol Access Library</a>). </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Call and return instrumentation </li>
<li>Per-thread logging </li>
<li>Optional symbol lookup with drsyms </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Building call flow traces </li>
<li>Investigating indirect call behavior</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_memtrace_simple"></a>
memtrace_simple.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/memtrace_simple.c">memtrace_simple.c</a> records instruction and memory-reference entries (type, size, address) into a per-thread buffer and dumps them to a text file using clean calls. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Memory operand analysis </li>
<li><a class="el" href="page_drutil.html">Instrumentation Utilities</a> helpers for address and size </li>
<li><a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> expansion of string and scatter/gather operations </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Studying memory access patterns </li>
<li>Validating memory reference instrumentation </li>
<li>For a full-featured instruction and data address tracing tool, see <a class="el" href="page_drcachesim.html">Tracing and Analysis Framework</a>.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_memtrace_x86"></a>
memtrace_x86.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/memtrace_x86.c">memtrace_x86.c</a> captures memory references on x86 with inline buffer filling and a local code cache for lean clean calls, writing binary or text traces per thread. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li><a class="el" href="page_drutil.html">Instrumentation Utilities</a> string and scatter/gather expansion </li>
<li>Local code cache generation </li>
<li>Per-thread buffering with lean clean calls </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>High-performance memory tracing </li>
<li>Generating binary traces for offline analysis </li>
<li>For a full-featured instruction and data address tracing tool, see <a class="el" href="page_drcachesim.html">Tracing and Analysis Framework</a>.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_memval_simple"></a>
memval_simple.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/memval_simple.c">memval_simple.c</a> records memory write addresses and the written bytes using drx_buf trace and circular buffers, flushing via a trace-buffer fault handler to per-thread log files. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Post-instruction instrumentation for write values </li>
<li><a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> trace and circular buffers with a fault handler (Buffer Filling API) </li>
<li>Memory operand address calculation with <a class="el" href="page_drutil.html">Instrumentation Utilities</a> </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Tracking data writes for debugging </li>
<li>Building lightweight memory value traces</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_modxfer"></a>
modxfer.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/modxfer.c">modxfer.c</a> counts instructions per module and tracks cross-module indirect branch transfers between any modules, logging summary statistics at exit. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Module load and unload tracking </li>
<li>Indirect branch instrumentation </li>
<li>Per-module counters with <a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Studying inter-module call patterns </li>
<li>Identifying frequent cross-module transfers</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_modxfer_app2lib"></a>
modxfer_app2lib.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/modxfer_app2lib.c">modxfer_app2lib.c</a> counts instructions in the main application versus libraries and tracks indirect call/jump transfers between them using per-basic-block clean calls. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Module range checks for app vs. library code </li>
<li>Clean call updates of per-basic-block counts </li>
<li>Indirect branch instrumentation for cross-module transfers </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Measuring time spent in app vs. libraries </li>
<li>Detecting app-to-lib transition frequency</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_opcode_count"></a>
opcode_count.cpp</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/opcode_count.cpp">opcode_count.cpp</a> counts executions of a selected opcode and the total instruction count using drmgr opcode instrumentation events and drx counter updates. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Opcode instrumentation events via <a class="el" href="page_drmgr.html">Multi-Instrumentation Manager</a> </li>
<li>Inline counter updates with <a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> </li>
<li>Runtime options via <a class="el" href="page_droption.html">DynamoRIO Option Parser</a> </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Focused opcode profiling </li>
<li>Regression checks for specific instruction patterns</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_opcodes"></a>
opcodes.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/opcodes.c">opcodes.c</a> counts dynamic instruction executions by opcode, grouped by ISA mode, and reports the top opcode counts at exit. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Basic block instrumentation </li>
<li>Inline counter updates with <a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> </li>
<li>ISA mode awareness </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Opcode mix profiling </li>
<li>Comparing dynamic behavior across workloads</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_prefetch"></a>
prefetch.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/prefetch.c">prefetch.c</a> removes prefetch and prefetchw instructions on Intel CPUs using an app2app pass, counting the removals for reporting. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>App2app instruction removal </li>
<li>CPU vendor detection </li>
<li>Thread-safe counting with a mutex </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Running AMD-optimized binaries on Intel CPUs </li>
<li>Testing instruction stream sanitization</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_signal"></a>
signal.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/signal.c">signal.c</a> monitors UNIX signals, suppressing SIGTERM and redirecting SIGSEGV by skipping the faulting instruction while counting signals seen. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Signal event callbacks (UNIX) </li>
<li>Signal suppression and redirection </li>
<li>Atomic counters </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Observing crash signals in a controlled way </li>
<li>Prototyping signal-based fault handling</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_ssljack"></a>
ssljack.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/ssljack.c">ssljack.c</a> wraps OpenSSL and GnuTLS read/write functions on module load and logs plaintext data to per-SSL-context files. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Module load events </li>
<li>Function wrapping (<a class="el" href="page_drwrap.html">Function Wrapping and Replacing Extension</a>) </li>
<li>Per-context file logging </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Inspecting decrypted SSL/TLS traffic </li>
<li>Debugging application-level crypto usage</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_statecmp"></a>
statecmp.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/statecmp.c">statecmp.c</a> uses <a class="el" href="page_drstatecmp.html">Machine State Comparison Library</a> to detect instrumentation-induced state mismatches by intentionally clobbering flags and handling mismatches via a user callback. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li><a class="el" href="page_drstatecmp.html">Machine State Comparison Library</a> integration </li>
<li>Instrumentation correctness checking </li>
<li>Custom mismatch callbacks </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Validating new instrumentation passes </li>
<li>Debugging subtle state clobbers</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_stats"></a>
stats.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/stats.c">stats.c</a> (Windows-only) exports instruction, floating-point, and syscall counters via shared memory for the stats viewer, using drx counter updates per basic block. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Shared memory usage for client stats </li>
<li>Inline counters with <a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> </li>
<li>Windows-specific API interactions </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Live statistics dashboards </li>
<li>Comparing runs without heavy logging</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_strace"></a>
strace.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/strace.c">strace.c</a> prints the name and result of every system call using the <a class="el" href="page_drsyscall.html">Dr. Syscall: System Call Monitoring Extension</a> extension from DRMF. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Syscall event callbacks via <a class="el" href="page_drsyscall.html">Dr. Syscall: System Call Monitoring Extension</a> </li>
<li>Syscall name lookup with DRMF </li>
<li>Result decoding </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Debugging unexpected syscalls </li>
<li>Building basic syscall traces</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_stl_test"></a>
stl_test.cpp</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/stl_test.cpp">stl_test.cpp</a> is a C++ client that exercises STL containers (vector, list, map) and optionally uses a TLS variable on UNIX when SHOW_RESULTS is enabled. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>C++ client setup </li>
<li>STL usage in a client </li>
<li>Exit event registration </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>C++ client scaffolding </li>
<li>Validating STL usage in DynamoRIO clients</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_syscall"></a>
syscall.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/syscall.c">syscall.c</a> monitors system calls, counts them, and modifies write syscalls (SYS_write/NtWriteFile) using drmgr’s pre/post syscall events and thread-context-local storage (<a class="el" href="page_drmgr.html">Multi-Instrumentation Manager</a>). </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Syscall interception events </li>
<li>Thread-context-local storage via drmgr CLS (<a class="el" href="page_drmgr.html">Multi-Instrumentation Manager</a>) </li>
<li>Platform-specific syscall handling and parameter modification </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Auditing syscall activity </li>
<li>Prototyping syscall rewriting</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_tracedump"></a>
tracedump.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/tracedump.c">tracedump.c</a> uses the standalone API to parse and disassemble binary trace dump files produced by the -tracedump_binary option. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Standalone API usage </li>
<li>Trace dump file parsing </li>
<li>Disassembly of cached code </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Inspecting trace dumps offline </li>
<li>Debugging code cache behavior</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_utils"></a>
utils.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/utils.c">utils.c</a> provides shared logging helpers for samples, including unique per-process log file creation and FILE* stream helpers. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Client path discovery </li>
<li>Log file creation helpers via <a class="el" href="page_drx.html">DynamoRIO eXtension utilities</a> </li>
<li>Stream helper utilities </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Reusing logging utilities across sample clients </li>
<li>Standardizing output file naming</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_sample_wrap"></a>
wrap.c</h2>
<p>The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/wrap.c">wrap.c</a> wraps malloc (Linux) or HeapAlloc (Windows) to track the maximum allocation size and optionally force occasional allocation failures. </p><dl class="section user"><dt>DynamoRIO concepts demonstrated</dt><dd><ul>
<li>Module load callbacks </li>
<li>Function wrapping (<a class="el" href="page_drwrap.html">Function Wrapping and Replacing Extension</a>) </li>
<li>Return value modification </li>
</ul>
</dd></dl>
<dl class="section user"><dt>Typical use cases</dt><dd><ul>
<li>Testing error handling paths </li>
<li>Tracking allocation patterns</li>
</ul>
</dd></dl>
<h1><a class="anchor" id="bt_examples"></a>
Discussion of Selected Samples</h1>
<h2><a class="anchor" id="sec_ex1"></a>
Instruction Counting</h2>
<p>We now illustrate how to use the above API to implement a simple instrumentation client for counting the number of executed call and return instructions in the input program. Full code for this example is in the file <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/countcalls.c">countcalls.c</a>.</p>
<p>The client maintains set of three counters: num_direct_calls, num_indirect_calls, and num_returns to count three different types of instructions during execution. It keeps both thread-private and global versions of these counters. The client initializes everything by supplying the following <code>dr_client_main</code> routine:</p>
<div class="fragment"><div class="line">DR_EXPORT <span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="dr__api_8h.html#a2b938c98dd186cc94eef6880f9e3c3e9">dr_client_main</a>(<a class="code" href="dr__defines_8h.html#a68540a70b4f8150a4fe6dcec91bf8825">client_id_t</a> <span class="keywordtype">id</span>, <span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/* register events */</span></div>
<div class="line">  <a class="code" href="dr__events_8h.html#a32f38cabf4b2c554ce4e476c5d5f6f3a">dr_register_exit_event</a>(event_exit);</div>
<div class="line">  <a class="code" href="dr__events_8h.html#a92ad96993c826232e76a56ff43cd31d0">dr_register_thread_init_event</a>(event_thread_init);</div>
<div class="line">  <a class="code" href="dr__events_8h.html#aa34d296a9e990925a096501a7d5c6596">dr_register_thread_exit_event</a>(event_thread_exit);</div>
<div class="line">  <a class="code" href="dr__events_8h.html#acbfe1ece2c520d409ffd59076507a710">dr_register_bb_event</a>(event_basic_block);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* make it easy to tell, by looking at log file, which client executed */</span></div>
<div class="line">  <a class="code" href="dr__tools_8h.html#aeea154f7dd2f1232aaba2e92d0a5cb24">dr_log</a>(NULL, <a class="code" href="dr__tools_8h.html#acab56792af6a64911a9e62dfeb8b0981">DR_LOG_ALL</a>, 1, <span class="stringliteral">&quot;Client &#39;countcalls&#39; initializing\n&quot;</span>);</div>
<div class="line">}</div>
<div class="ttc" id="adr__api_8h_html_a2b938c98dd186cc94eef6880f9e3c3e9"><div class="ttname"><a href="dr__api_8h.html#a2b938c98dd186cc94eef6880f9e3c3e9">dr_client_main</a></div><div class="ttdeci">DR_EXPORT void dr_client_main(client_id_t id, int argc, const char *argv[])</div></div>
<div class="ttc" id="adr__defines_8h_html_a68540a70b4f8150a4fe6dcec91bf8825"><div class="ttname"><a href="dr__defines_8h.html#a68540a70b4f8150a4fe6dcec91bf8825">client_id_t</a></div><div class="ttdeci">uint client_id_t</div><div class="ttdef"><b>Definition:</b> dr_defines.h:357</div></div>
<div class="ttc" id="adr__events_8h_html_a32f38cabf4b2c554ce4e476c5d5f6f3a"><div class="ttname"><a href="dr__events_8h.html#a32f38cabf4b2c554ce4e476c5d5f6f3a">dr_register_exit_event</a></div><div class="ttdeci">DR_API void dr_register_exit_event(void(*func)(void))</div></div>
<div class="ttc" id="adr__events_8h_html_a92ad96993c826232e76a56ff43cd31d0"><div class="ttname"><a href="dr__events_8h.html#a92ad96993c826232e76a56ff43cd31d0">dr_register_thread_init_event</a></div><div class="ttdeci">DR_API void dr_register_thread_init_event(void(*func)(void *drcontext))</div></div>
<div class="ttc" id="adr__events_8h_html_aa34d296a9e990925a096501a7d5c6596"><div class="ttname"><a href="dr__events_8h.html#aa34d296a9e990925a096501a7d5c6596">dr_register_thread_exit_event</a></div><div class="ttdeci">DR_API void dr_register_thread_exit_event(void(*func)(void *drcontext))</div></div>
<div class="ttc" id="adr__events_8h_html_acbfe1ece2c520d409ffd59076507a710"><div class="ttname"><a href="dr__events_8h.html#acbfe1ece2c520d409ffd59076507a710">dr_register_bb_event</a></div><div class="ttdeci">DR_API void dr_register_bb_event(dr_emit_flags_t(*func)(void *drcontext, void *tag, instrlist_t *bb, bool for_trace, bool translating))</div></div>
<div class="ttc" id="adr__tools_8h_html_acab56792af6a64911a9e62dfeb8b0981"><div class="ttname"><a href="dr__tools_8h.html#acab56792af6a64911a9e62dfeb8b0981">DR_LOG_ALL</a></div><div class="ttdeci">#define DR_LOG_ALL</div><div class="ttdef"><b>Definition:</b> dr_tools.h:1617</div></div>
<div class="ttc" id="adr__tools_8h_html_aeea154f7dd2f1232aaba2e92d0a5cb24"><div class="ttname"><a href="dr__tools_8h.html#aeea154f7dd2f1232aaba2e92d0a5cb24">dr_log</a></div><div class="ttdeci">DR_API void dr_log(void *drcontext, uint mask, uint level, const char *fmt,...)</div></div>
</div><!-- fragment --><p>The client provides an event_exit routine that displays the final values of the global counters as well as a thread_exit routine that shows the counter totals on a per-thread basis.</p>
<p>The client keeps track of each thread's instruction counts separately. To do this, it creates a data structure that will be separately allocated for each thread:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">  <span class="keywordtype">int</span> num_direct_calls;</div>
<div class="line">  <span class="keywordtype">int</span> num_indirect_calls;</div>
<div class="line">  <span class="keywordtype">int</span> num_returns;</div>
<div class="line">} per_thread_t;</div>
</div><!-- fragment --><p>Now the thread hooks are used to initialize the data structure and to display the thread-private totals :</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> event_thread_init(<span class="keywordtype">void</span> *drcontext)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/* create an instance of our data structure for this thread */</span></div>
<div class="line">  per_thread *data = (per_thread *)</div>
<div class="line">    <a class="code" href="dr__tools_8h.html#a18d391b20559c1737c795f2ef1ba33d2">dr_thread_alloc</a>(drcontext, <span class="keyword">sizeof</span>(per_thread));</div>
<div class="line">  <span class="comment">/* store it in the slot provided in the drcontext */</span></div>
<div class="line">  <a class="code" href="dr__tools_8h.html#a534b38808801da50be64b9f0e6c8616f">dr_set_tls_field</a>(drcontext, data);</div>
<div class="line">  data-&gt;num_direct_calls = 0;</div>
<div class="line">  data-&gt;num_indirect_calls = 0;</div>
<div class="line">  data-&gt;num_returns = 0;</div>
<div class="line">  <a class="code" href="dr__tools_8h.html#aeea154f7dd2f1232aaba2e92d0a5cb24">dr_log</a>(drcontext, <a class="code" href="dr__tools_8h.html#acab56792af6a64911a9e62dfeb8b0981">DR_LOG_ALL</a>, 1, <span class="stringliteral">&quot;countcalls: set up for thread &quot;</span><a class="code" href="dr__defines_8h.html#a80e139e8f2d2dd7d5d4a92f8ad7c6f4d">TIDFMT</a><span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">         <a class="code" href="dr__tools_8h.html#a56eae1c5bac30a5336a99c5d91d5a10c">dr_get_thread_id</a>(drcontext));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> event_thread_exit(<span class="keywordtype">void</span> *drcontext)</div>
<div class="line">{</div>
<div class="line">  per_thread *data = (per_thread *) <a class="code" href="dr__tools_8h.html#aaa04a14c2cbf783b4926c2fd14445f82">dr_get_tls_field</a>(drcontext);</div>
<div class="line"> </div>
<div class="line">  ... <span class="comment">// string formatting and displaying</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* clean up memory */</span></div>
<div class="line">  <a class="code" href="dr__tools_8h.html#aada5a5987fa20f96868c453cd9baacd3">dr_thread_free</a>(drcontext, data, <span class="keyword">sizeof</span>(per_thread));</div>
<div class="line">}</div>
<div class="ttc" id="adr__defines_8h_html_a80e139e8f2d2dd7d5d4a92f8ad7c6f4d"><div class="ttname"><a href="dr__defines_8h.html#a80e139e8f2d2dd7d5d4a92f8ad7c6f4d">TIDFMT</a></div><div class="ttdeci">#define TIDFMT</div><div class="ttdef"><b>Definition:</b> dr_defines.h:648</div></div>
<div class="ttc" id="adr__tools_8h_html_a18d391b20559c1737c795f2ef1ba33d2"><div class="ttname"><a href="dr__tools_8h.html#a18d391b20559c1737c795f2ef1ba33d2">dr_thread_alloc</a></div><div class="ttdeci">DR_API void * dr_thread_alloc(void *drcontext, size_t size)</div></div>
<div class="ttc" id="adr__tools_8h_html_a534b38808801da50be64b9f0e6c8616f"><div class="ttname"><a href="dr__tools_8h.html#a534b38808801da50be64b9f0e6c8616f">dr_set_tls_field</a></div><div class="ttdeci">DR_API void dr_set_tls_field(void *drcontext, void *value)</div></div>
<div class="ttc" id="adr__tools_8h_html_a56eae1c5bac30a5336a99c5d91d5a10c"><div class="ttname"><a href="dr__tools_8h.html#a56eae1c5bac30a5336a99c5d91d5a10c">dr_get_thread_id</a></div><div class="ttdeci">DR_API thread_id_t dr_get_thread_id(void *drcontext)</div></div>
<div class="ttc" id="adr__tools_8h_html_aaa04a14c2cbf783b4926c2fd14445f82"><div class="ttname"><a href="dr__tools_8h.html#aaa04a14c2cbf783b4926c2fd14445f82">dr_get_tls_field</a></div><div class="ttdeci">DR_API void * dr_get_tls_field(void *drcontext)</div></div>
<div class="ttc" id="adr__tools_8h_html_aada5a5987fa20f96868c453cd9baacd3"><div class="ttname"><a href="dr__tools_8h.html#aada5a5987fa20f96868c453cd9baacd3">dr_thread_free</a></div><div class="ttdeci">DR_API void dr_thread_free(void *drcontext, void *mem, size_t size)</div></div>
</div><!-- fragment --><p>The real work is done in the basic block hook. We simply look for the instructions we're interested in and insert an increment of the appropriate thread-local and global counters, remembering to save the flags, of course. This sample has separate paths for incrementing the thread private counts for shared vs. thread-private caches (see the -thread_private option) to illustrate the differences in targeting for them. Note that the shared path would work fine with private caches.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">insert_counter_update(<span class="keywordtype">void</span> *drcontext, <a class="code" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *bb, <a class="code" href="structinstr__t.html">instr_t</a> *where, <span class="keywordtype">int</span> offset)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/* Since the inc instruction clobbers 5 of the arithmetic eflags,</span></div>
<div class="line"><span class="comment">   * we have to save them around the inc. We could be more efficient</span></div>
<div class="line"><span class="comment">   * by not bothering to save the overflow flag and constructing our</span></div>
<div class="line"><span class="comment">   * own sequence of instructions to save the other 5 flags (using</span></div>
<div class="line"><span class="comment">   * lahf) or by doing a liveness analysis on the flags and saving</span></div>
<div class="line"><span class="comment">   * only if live.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a class="code" href="dr__ir__utils_8h.html#abd9f556b8175c4ac72d8e7df8295f121">dr_save_arith_flags</a>(drcontext, bb, where, SPILL_SLOT_1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Increment the global counter using the lock prefix to make it atomic</span></div>
<div class="line"><span class="comment">   * across threads. It would be cheaper to aggregate the thread counters</span></div>
<div class="line"><span class="comment">   * in the exit events, but this sample is intended to illustrate inserted</span></div>
<div class="line"><span class="comment">   * instrumentation.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a class="code" href="dr__ir__utils_8h.html#a4c8c687663c2f51e60e564ca9626acea">instrlist_meta_preinsert</a>(bb, where, <a class="code" href="dr__ir__macros__x86_8h.html#a8104e895719c1f3a8558067b023cf9c5">LOCK</a>(<a class="code" href="dr__ir__macros__x86_8h.html#a759b7342ed4080b9c12809d3b2e2718a">INSTR_CREATE_inc</a></div>
<div class="line">    (drcontext, <a class="code" href="dr__ir__macros__aarch64_8h.html#a54b8bd667a8a940e94bfcc7842c958eb">OPND_CREATE_ABSMEM</a>(((<span class="keywordtype">byte</span> *)&amp;global_count) + offset, <a class="code" href="dr__ir__opnd_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da0ccef0d75b3f473bf275388804c8b85c">OPSZ_4</a>))));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Increment the thread private counter. */</span></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="dr__tools_8h.html#a684c0fc332a5e5aa11c28ad3d1a6ef57">dr_using_all_private_caches</a>()) {</div>
<div class="line">    per_thread_t *data = (per_thread_t *) <a class="code" href="dr__tools_8h.html#aaa04a14c2cbf783b4926c2fd14445f82">dr_get_tls_field</a>(drcontext);</div>
<div class="line">    <span class="comment">/* private caches - we can use an absolute address */</span></div>
<div class="line">    <a class="code" href="dr__ir__utils_8h.html#a4c8c687663c2f51e60e564ca9626acea">instrlist_meta_preinsert</a>(bb, where, <a class="code" href="dr__ir__macros__x86_8h.html#a759b7342ed4080b9c12809d3b2e2718a">INSTR_CREATE_inc</a>(drcontext,</div>
<div class="line">        <a class="code" href="dr__ir__macros__aarch64_8h.html#a54b8bd667a8a940e94bfcc7842c958eb">OPND_CREATE_ABSMEM</a>(((<span class="keywordtype">byte</span> *)&amp;data) + offset, <a class="code" href="dr__ir__opnd_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da0ccef0d75b3f473bf275388804c8b85c">OPSZ_4</a>)));</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* shared caches - we must indirect via thread local storage */</span></div>
<div class="line">    <span class="comment">/* We spill xbx to use a scratch register (we could do a liveness</span></div>
<div class="line"><span class="comment">     * analysis to try and find a dead register to use). Note that xax</span></div>
<div class="line"><span class="comment">     * is currently holding the saved eflags. */</span></div>
<div class="line">    <a class="code" href="dr__ir__utils_8h.html#ae8479716f08bbbb36d7fd27cfbbc0743">dr_save_reg</a>(drcontext, bb, where, REG_XBX, <a class="code" href="dr__ir__utils_8h.html#a89a6b714ff24d91d78589877047a29b9ae4cd78beccb2525acc61f2536ba1ea71">SPILL_SLOT_2</a>);</div>
<div class="line">    <a class="code" href="dr__ir__utils_8h.html#aab7b4392c68e53f807bba5791183f240">dr_insert_read_tls_field</a>(drcontext, bb, where, REG_XBX);</div>
<div class="line">    <a class="code" href="dr__ir__utils_8h.html#a4c8c687663c2f51e60e564ca9626acea">instrlist_meta_preinsert</a>(bb, where,</div>
<div class="line">        <a class="code" href="dr__ir__macros__x86_8h.html#a759b7342ed4080b9c12809d3b2e2718a">INSTR_CREATE_inc</a>(drcontext, <a class="code" href="dr__ir__macros_8h.html#a026e7031693d6f0e4d53af107e0a1827">OPND_CREATE_MEM32</a>(REG_XBX, offset)));</div>
<div class="line">    <a class="code" href="dr__ir__utils_8h.html#a97e9767e1ff0f426b552a5f18c528ced">dr_restore_reg</a>(drcontext, bb, where, REG_XBX, <a class="code" href="dr__ir__utils_8h.html#a89a6b714ff24d91d78589877047a29b9ae4cd78beccb2525acc61f2536ba1ea71">SPILL_SLOT_2</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* restore flags */</span></div>
<div class="line">  <a class="code" href="dr__ir__utils_8h.html#a31b8fd731ecc840fcddda04c36a7eadd">dr_restore_arith_flags</a>(drcontext, bb, where, SPILL_SLOT_1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="dr__events_8h.html#a689518ac5d1ad136b13e03012702b209">dr_emit_flags_t</a></div>
<div class="line">event_basic_block(<span class="keywordtype">void</span> *drcontext, <span class="keywordtype">void</span> *tag, <a class="code" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *bb,</div>
<div class="line">                  <span class="keywordtype">bool</span> for_trace, <span class="keywordtype">bool</span> translating)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structinstr__t.html">instr_t</a> *instr, *next_instr;</div>
<div class="line"> </div>
<div class="line">  ... <span class="comment">// some logging</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (instr = <a class="code" href="dr__ir__instrlist_8h.html#a6491763e4a1534458a8d7034c8f69612">instrlist_first</a>(bb); instr != NULL; instr = next_instr) {</div>
<div class="line">    <span class="comment">/* grab next now so we don&#39;t go over instructions we insert */</span></div>
<div class="line">    next_instr = <a class="code" href="dr__ir__instr_8h.html#ac897243e24d71890e196586b8373b821">instr_get_next</a>(instr);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* instrument calls and returns -- ignore far calls/rets */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="dr__ir__instr_8h.html#aa5c9a74196c2f1e5bdf92ba80704ef5e">instr_is_call_direct</a>(instr)) {</div>
<div class="line">      insert_counter_update(drcontext, bb, instr,</div>
<div class="line">                            offsetof(per_thread_t, num_direct_calls));</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="dr__ir__instr_8h.html#a0d26dfac56f88e18b9f1d8c77da128bc">instr_is_call_indirect</a>(instr)) {</div>
<div class="line">      insert_counter_update(drcontext, bb, instr,</div>
<div class="line">                            offsetof(per_thread_t, num_indirect_calls));</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="dr__ir__instr_8h.html#af1bd61ffeb33af0bc87e4660a69de71d">instr_is_return</a>(instr)) {</div>
<div class="line">      insert_counter_update(drcontext, bb, instr,</div>
<div class="line">                            offsetof(per_thread_t, num_returns));</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  ... <span class="comment">// some logging</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="dr__events_8h.html#a689518ac5d1ad136b13e03012702b209a7d25c4546544d1a8c0b77c69230772eb">DR_EMIT_DEFAULT</a>;</div>
<div class="line">}</div>
<div class="ttc" id="adr__defines_8h_html_a3fb73c55def575ec5705577625491d66"><div class="ttname"><a href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a></div><div class="ttdeci">struct _instrlist_t instrlist_t</div><div class="ttdef"><b>Definition:</b> dr_defines.h:908</div></div>
<div class="ttc" id="adr__events_8h_html_a689518ac5d1ad136b13e03012702b209"><div class="ttname"><a href="dr__events_8h.html#a689518ac5d1ad136b13e03012702b209">dr_emit_flags_t</a></div><div class="ttdeci">dr_emit_flags_t</div><div class="ttdef"><b>Definition:</b> dr_events.h:145</div></div>
<div class="ttc" id="adr__events_8h_html_a689518ac5d1ad136b13e03012702b209a7d25c4546544d1a8c0b77c69230772eb"><div class="ttname"><a href="dr__events_8h.html#a689518ac5d1ad136b13e03012702b209a7d25c4546544d1a8c0b77c69230772eb">DR_EMIT_DEFAULT</a></div><div class="ttdeci">@ DR_EMIT_DEFAULT</div><div class="ttdef"><b>Definition:</b> dr_events.h:147</div></div>
<div class="ttc" id="adr__ir__instr_8h_html_a0d26dfac56f88e18b9f1d8c77da128bc"><div class="ttname"><a href="dr__ir__instr_8h.html#a0d26dfac56f88e18b9f1d8c77da128bc">instr_is_call_indirect</a></div><div class="ttdeci">DR_API bool instr_is_call_indirect(instr_t *instr)</div></div>
<div class="ttc" id="adr__ir__instr_8h_html_aa5c9a74196c2f1e5bdf92ba80704ef5e"><div class="ttname"><a href="dr__ir__instr_8h.html#aa5c9a74196c2f1e5bdf92ba80704ef5e">instr_is_call_direct</a></div><div class="ttdeci">DR_API bool instr_is_call_direct(instr_t *instr)</div></div>
<div class="ttc" id="adr__ir__instr_8h_html_ac897243e24d71890e196586b8373b821"><div class="ttname"><a href="dr__ir__instr_8h.html#ac897243e24d71890e196586b8373b821">instr_get_next</a></div><div class="ttdeci">DR_API INSTR_INLINE instr_t * instr_get_next(instr_t *instr)</div></div>
<div class="ttc" id="adr__ir__instr_8h_html_af1bd61ffeb33af0bc87e4660a69de71d"><div class="ttname"><a href="dr__ir__instr_8h.html#af1bd61ffeb33af0bc87e4660a69de71d">instr_is_return</a></div><div class="ttdeci">DR_API bool instr_is_return(instr_t *instr)</div></div>
<div class="ttc" id="adr__ir__instrlist_8h_html_a6491763e4a1534458a8d7034c8f69612"><div class="ttname"><a href="dr__ir__instrlist_8h.html#a6491763e4a1534458a8d7034c8f69612">instrlist_first</a></div><div class="ttdeci">DR_API instr_t * instrlist_first(instrlist_t *ilist)</div></div>
<div class="ttc" id="adr__ir__macros_8h_html_a026e7031693d6f0e4d53af107e0a1827"><div class="ttname"><a href="dr__ir__macros_8h.html#a026e7031693d6f0e4d53af107e0a1827">OPND_CREATE_MEM32</a></div><div class="ttdeci">#define OPND_CREATE_MEM32(base_reg, disp)</div><div class="ttdef"><b>Definition:</b> dr_ir_macros.h:82</div></div>
<div class="ttc" id="adr__ir__macros__aarch64_8h_html_a54b8bd667a8a940e94bfcc7842c958eb"><div class="ttname"><a href="dr__ir__macros__aarch64_8h.html#a54b8bd667a8a940e94bfcc7842c958eb">OPND_CREATE_ABSMEM</a></div><div class="ttdeci">#define OPND_CREATE_ABSMEM(addr, size)</div><div class="ttdef"><b>Definition:</b> dr_ir_macros_aarch64.h:102</div></div>
<div class="ttc" id="adr__ir__macros__x86_8h_html_a759b7342ed4080b9c12809d3b2e2718a"><div class="ttname"><a href="dr__ir__macros__x86_8h.html#a759b7342ed4080b9c12809d3b2e2718a">INSTR_CREATE_inc</a></div><div class="ttdeci">#define INSTR_CREATE_inc(dc, d)</div><div class="ttdef"><b>Definition:</b> dr_ir_macros_x86.h:1626</div></div>
<div class="ttc" id="adr__ir__macros__x86_8h_html_a8104e895719c1f3a8558067b023cf9c5"><div class="ttname"><a href="dr__ir__macros__x86_8h.html#a8104e895719c1f3a8558067b023cf9c5">LOCK</a></div><div class="ttdeci">#define LOCK(instr_ptr)</div><div class="ttdef"><b>Definition:</b> dr_ir_macros_x86.h:60</div></div>
<div class="ttc" id="adr__ir__opnd_8h_html_a0411cd49bb5b71852cecd93bcbf0ca2da0ccef0d75b3f473bf275388804c8b85c"><div class="ttname"><a href="dr__ir__opnd_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da0ccef0d75b3f473bf275388804c8b85c">OPSZ_4</a></div><div class="ttdeci">@ OPSZ_4</div><div class="ttdef"><b>Definition:</b> dr_ir_opnd.h:85</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_a31b8fd731ecc840fcddda04c36a7eadd"><div class="ttname"><a href="dr__ir__utils_8h.html#a31b8fd731ecc840fcddda04c36a7eadd">dr_restore_arith_flags</a></div><div class="ttdeci">DR_API void dr_restore_arith_flags(void *drcontext, instrlist_t *ilist, instr_t *where, dr_spill_slot_t slot)</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_a4c8c687663c2f51e60e564ca9626acea"><div class="ttname"><a href="dr__ir__utils_8h.html#a4c8c687663c2f51e60e564ca9626acea">instrlist_meta_preinsert</a></div><div class="ttdeci">DR_API void instrlist_meta_preinsert(instrlist_t *ilist, instr_t *where, instr_t *instr)</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_a89a6b714ff24d91d78589877047a29b9ae4cd78beccb2525acc61f2536ba1ea71"><div class="ttname"><a href="dr__ir__utils_8h.html#a89a6b714ff24d91d78589877047a29b9ae4cd78beccb2525acc61f2536ba1ea71">SPILL_SLOT_2</a></div><div class="ttdeci">@ SPILL_SLOT_2</div><div class="ttdef"><b>Definition:</b> dr_ir_utils.h:68</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_a97e9767e1ff0f426b552a5f18c528ced"><div class="ttname"><a href="dr__ir__utils_8h.html#a97e9767e1ff0f426b552a5f18c528ced">dr_restore_reg</a></div><div class="ttdeci">DR_API void dr_restore_reg(void *drcontext, instrlist_t *ilist, instr_t *where, reg_id_t reg, dr_spill_slot_t slot)</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_aab7b4392c68e53f807bba5791183f240"><div class="ttname"><a href="dr__ir__utils_8h.html#aab7b4392c68e53f807bba5791183f240">dr_insert_read_tls_field</a></div><div class="ttdeci">DR_API void dr_insert_read_tls_field(void *drcontext, instrlist_t *ilist, instr_t *where, reg_id_t reg)</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_abd9f556b8175c4ac72d8e7df8295f121"><div class="ttname"><a href="dr__ir__utils_8h.html#abd9f556b8175c4ac72d8e7df8295f121">dr_save_arith_flags</a></div><div class="ttdeci">DR_API void dr_save_arith_flags(void *drcontext, instrlist_t *ilist, instr_t *where, dr_spill_slot_t slot)</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_ae8479716f08bbbb36d7fd27cfbbc0743"><div class="ttname"><a href="dr__ir__utils_8h.html#ae8479716f08bbbb36d7fd27cfbbc0743">dr_save_reg</a></div><div class="ttdeci">DR_API void dr_save_reg(void *drcontext, instrlist_t *ilist, instr_t *where, reg_id_t reg, dr_spill_slot_t slot)</div></div>
<div class="ttc" id="adr__tools_8h_html_a684c0fc332a5e5aa11c28ad3d1a6ef57"><div class="ttname"><a href="dr__tools_8h.html#a684c0fc332a5e5aa11c28ad3d1a6ef57">dr_using_all_private_caches</a></div><div class="ttdeci">DR_API bool dr_using_all_private_caches(void)</div></div>
<div class="ttc" id="astructinstr__t_html"><div class="ttname"><a href="structinstr__t.html">instr_t</a></div><div class="ttdef"><b>Definition:</b> dr_defines.h:378</div></div>
</div><!-- fragment --><dl class="section user"><dt>Building the Example</dt><dd></dd></dl>
<p>For general instructions on building a client, see <a class="el" href="page_build_client.html">How to Build a Tool</a>.</p>
<p>To build the <code>instrcalls.c</code> client using CMake, if <code>DYNAMORIO_HOME</code> is set to the base of the DynamoRIO release package:</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -DDynamoRIO_DIR=$DYNAMORIO_HOME/cmake $DYNAMORIO_HOME/samples</div>
<div class="line">make instrcalls</div>
</div><!-- fragment --><p>To build 32-bit samples when using gcc with a default of 64-bit, use:</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">CFLAGS=-m32 CXXFLAGS=-m32 cmake -DDynamoRIO_DIR=$DYNAMORIO_HOME/cmake $DYNAMORIO_HOME/samples</div>
<div class="line">make instrcalls</div>
</div><!-- fragment --><p>The result is a shared library instrcalls.dll or libinstrcalls.so. To invoke the client library, follow the instructions under <a class="el" href="page_deploy.html">How to Run</a>.</p>
<h2><a class="anchor" id="sec_ex2"></a>
Instruction Profiling</h2>
<p>The next example shows how to use the provided control flow instrumentation routines, which allow more sophisticated profiling than simply counting instructions. Full code for this example is in the file <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/instrcalls.c">instrcalls.c</a>.</p>
<p>As in the previous example, the client is interested in direct and indirect calls and returns. The client wants to analyze the target address of each dynamic instance of a call or return. For our example, we simply dump the data in text format to a separate file for each thread. Since FILE cannot be exported from a DLL on Windows, we use the DynamoRIO-provided file_t type that hides the distinction between FILE and HANDLE to allow the same code to work on Linux and Windows. We make use of the thread initialization and exit routines to open and close the file. We store the file for a thread in the user slot in the drcontext.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> event_thread_init(<span class="keywordtype">void</span> *drcontext)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/* we&#39;re going to dump our data to a per-thread file */</span></div>
<div class="line">  file_t f;</div>
<div class="line">  <span class="keywordtype">char</span> logname[512];</div>
<div class="line"> </div>
<div class="line">  ... <span class="comment">// filename generation</span></div>
<div class="line"> </div>
<div class="line">  f = <a class="code" href="dr__tools_8h.html#a8c1399687e4cbc3c0b9bddab3e7619d3">dr_open_file</a>(fname, <span class="keyword">false</span><span class="comment">/*write*/</span>);</div>
<div class="line">  <a class="code" href="dr__tools_8h.html#a7c07630dffdfd92bc6ee63abf405768c">DR_ASSERT</a>(f != <a class="code" href="dr__defines_8h.html#a5f22fa59d1d8caa3fa4750147f559043">INVALID_FILE</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* store it in the slot provided in the drcontext */</span></div>
<div class="line">  <a class="code" href="dr__tools_8h.html#a534b38808801da50be64b9f0e6c8616f">dr_set_tls_field</a>(drcontext, (<span class="keywordtype">void</span> *)f);</div>
<div class="line"> </div>
<div class="line">  ... <span class="comment">// logging</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> event_thread_exit(<span class="keywordtype">void</span> *drcontext)</div>
<div class="line">{</div>
<div class="line">  file_t f = (file_t)(ptr_uint_t) <a class="code" href="dr__tools_8h.html#aaa04a14c2cbf783b4926c2fd14445f82">dr_get_tls_field</a>(drcontext);</div>
<div class="line">  <a class="code" href="dr__tools_8h.html#a2f9ce8187cd9bff18c879978a9ab1b8a">dr_close_file</a>(f);</div>
<div class="line">}</div>
<div class="ttc" id="adr__defines_8h_html_a5f22fa59d1d8caa3fa4750147f559043"><div class="ttname"><a href="dr__defines_8h.html#a5f22fa59d1d8caa3fa4750147f559043">INVALID_FILE</a></div><div class="ttdeci">#define INVALID_FILE</div><div class="ttdef"><b>Definition:</b> dr_defines.h:332</div></div>
<div class="ttc" id="adr__tools_8h_html_a2f9ce8187cd9bff18c879978a9ab1b8a"><div class="ttname"><a href="dr__tools_8h.html#a2f9ce8187cd9bff18c879978a9ab1b8a">dr_close_file</a></div><div class="ttdeci">DR_API void dr_close_file(file_t f)</div></div>
<div class="ttc" id="adr__tools_8h_html_a7c07630dffdfd92bc6ee63abf405768c"><div class="ttname"><a href="dr__tools_8h.html#a7c07630dffdfd92bc6ee63abf405768c">DR_ASSERT</a></div><div class="ttdeci">#define DR_ASSERT(x)</div><div class="ttdef"><b>Definition:</b> dr_tools.h:114</div></div>
<div class="ttc" id="adr__tools_8h_html_a8c1399687e4cbc3c0b9bddab3e7619d3"><div class="ttname"><a href="dr__tools_8h.html#a8c1399687e4cbc3c0b9bddab3e7619d3">dr_open_file</a></div><div class="ttdeci">DR_API file_t dr_open_file(const char *fname, uint mode_flags)</div></div>
</div><!-- fragment --><p>The basic block hook inserts a call to a procedure for each type of instruction, using the API-provided dr_insert_call_instrumentation and dr_insert_mbr_instrumentation routines, which insert calls to procedures with a certain signature.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="dr__events_8h.html#a689518ac5d1ad136b13e03012702b209">dr_emit_flags_t</a></div>
<div class="line">event_basic_block(<span class="keywordtype">void</span> *drcontext, <span class="keywordtype">void</span> *tag, <a class="code" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *bb,</div>
<div class="line">                  <span class="keywordtype">bool</span> for_trace, <span class="keywordtype">bool</span> translating)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structinstr__t.html">instr_t</a> *instr, *next_instr;</div>
<div class="line"> </div>
<div class="line">  ... <span class="comment">// logging</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (instr = <a class="code" href="dr__ir__instrlist_8h.html#a6491763e4a1534458a8d7034c8f69612">instrlist_first</a>(bb); instr != NULL; instr = next_instr) {</div>
<div class="line">    next_instr = <a class="code" href="dr__ir__instr_8h.html#ac897243e24d71890e196586b8373b821">instr_get_next</a>(instr);</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="dr__ir__instr_8h.html#a0dcbe0be5c00766249964bb3919e9a63">instr_opcode_valid</a>(instr))</div>
<div class="line">        <span class="keywordflow">continue</span>;</div>
<div class="line">    <span class="comment">/* instrument calls and returns -- ignore far calls/rets */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="dr__ir__instr_8h.html#aa5c9a74196c2f1e5bdf92ba80704ef5e">instr_is_call_direct</a>(instr)) {</div>
<div class="line">        <a class="code" href="dr__ir__utils_8h.html#aa27020a55e63afdf3e053dbe4a34ab97">dr_insert_call_instrumentation</a>(drcontext, bb, instr, (app_pc)at_call);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="dr__ir__instr_8h.html#a0d26dfac56f88e18b9f1d8c77da128bc">instr_is_call_indirect</a>(instr)) {</div>
<div class="line">        <a class="code" href="dr__ir__utils_8h.html#ac50b49843cf02a5b5f91fc6b5264cc7c">dr_insert_mbr_instrumentation</a>(drcontext, bb, instr, (app_pc)at_call_ind,</div>
<div class="line">                                      SPILL_SLOT_1);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="dr__ir__instr_8h.html#af1bd61ffeb33af0bc87e4660a69de71d">instr_is_return</a>(instr)) {</div>
<div class="line">        <a class="code" href="dr__ir__utils_8h.html#ac50b49843cf02a5b5f91fc6b5264cc7c">dr_insert_mbr_instrumentation</a>(drcontext, bb, instr, (app_pc)at_return,</div>
<div class="line">                                      SPILL_SLOT_1);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="dr__events_8h.html#a689518ac5d1ad136b13e03012702b209a7d25c4546544d1a8c0b77c69230772eb">DR_EMIT_DEFAULT</a>;</div>
<div class="line">}</div>
<div class="ttc" id="adr__ir__instr_8h_html_a0dcbe0be5c00766249964bb3919e9a63"><div class="ttname"><a href="dr__ir__instr_8h.html#a0dcbe0be5c00766249964bb3919e9a63">instr_opcode_valid</a></div><div class="ttdeci">DR_API bool instr_opcode_valid(instr_t *instr)</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_aa27020a55e63afdf3e053dbe4a34ab97"><div class="ttname"><a href="dr__ir__utils_8h.html#aa27020a55e63afdf3e053dbe4a34ab97">dr_insert_call_instrumentation</a></div><div class="ttdeci">DR_API void dr_insert_call_instrumentation(void *drcontext, instrlist_t *ilist, instr_t *instr, void *callee)</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_ac50b49843cf02a5b5f91fc6b5264cc7c"><div class="ttname"><a href="dr__ir__utils_8h.html#ac50b49843cf02a5b5f91fc6b5264cc7c">dr_insert_mbr_instrumentation</a></div><div class="ttdeci">DR_API void dr_insert_mbr_instrumentation(void *drcontext, instrlist_t *ilist, instr_t *instr, void *callee, dr_spill_slot_t scratch_slot)</div></div>
</div><!-- fragment --><p>These procedures look like this :</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">at_call(app_pc instr_addr, app_pc target_addr)</div>
<div class="line">{</div>
<div class="line">  file_t f = (file_t)(ptr_uint_t) <a class="code" href="dr__tools_8h.html#aaa04a14c2cbf783b4926c2fd14445f82">dr_get_tls_field</a>(<a class="code" href="dr__tools_8h.html#a317a1bb4c01ab9e6e64d2644d0ea984c">dr_get_current_drcontext</a>());</div>
<div class="line">  <a class="code" href="struct__dr__mcontext__t.html">dr_mcontext_t</a> mc;</div>
<div class="line">  <a class="code" href="dr__ir__utils_8h.html#a9e348b2596b8750ce3fad234ab022ced">dr_get_mcontext</a>(<a class="code" href="dr__tools_8h.html#a317a1bb4c01ab9e6e64d2644d0ea984c">dr_get_current_drcontext</a>(), &amp;mc, NULL);</div>
<div class="line">  <a class="code" href="dr__tools_8h.html#ae338685a241cfeae5f3d507ae9cff957">dr_fprintf</a>(f, <span class="stringliteral">&quot;CALL @ &quot;</span><a class="code" href="dr__defines_8h.html#a176e4c39a833f4d01f0ecd322c0f4343">PFX</a><span class="stringliteral">&quot; to &quot;</span><a class="code" href="dr__defines_8h.html#a176e4c39a833f4d01f0ecd322c0f4343">PFX</a><span class="stringliteral">&quot;, TOS is &quot;</span><a class="code" href="dr__defines_8h.html#a176e4c39a833f4d01f0ecd322c0f4343">PFX</a><span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">             instr_addr, target_addr, mc.xsp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">at_call_ind(app_pc instr_addr, app_pc target_addr)</div>
<div class="line">{</div>
<div class="line">  file_t f = (file_t)(ptr_uint_t) <a class="code" href="dr__tools_8h.html#aaa04a14c2cbf783b4926c2fd14445f82">dr_get_tls_field</a>(<a class="code" href="dr__tools_8h.html#a317a1bb4c01ab9e6e64d2644d0ea984c">dr_get_current_drcontext</a>());</div>
<div class="line">  <a class="code" href="dr__tools_8h.html#ae338685a241cfeae5f3d507ae9cff957">dr_fprintf</a>(f, <span class="stringliteral">&quot;CALL INDIRECT @ &quot;</span><a class="code" href="dr__defines_8h.html#a176e4c39a833f4d01f0ecd322c0f4343">PFX</a><span class="stringliteral">&quot; to &quot;</span><a class="code" href="dr__defines_8h.html#a176e4c39a833f4d01f0ecd322c0f4343">PFX</a><span class="stringliteral">&quot;\n&quot;</span>, instr_addr, target_addr);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">at_return(app_pc instr_addr, app_pc target_addr)</div>
<div class="line">{</div>
<div class="line">  file_t f = (file_t)(ptr_uint_t) <a class="code" href="dr__tools_8h.html#aaa04a14c2cbf783b4926c2fd14445f82">dr_get_tls_field</a>(<a class="code" href="dr__tools_8h.html#a317a1bb4c01ab9e6e64d2644d0ea984c">dr_get_current_drcontext</a>());</div>
<div class="line">  <a class="code" href="dr__tools_8h.html#ae338685a241cfeae5f3d507ae9cff957">dr_fprintf</a>(f, <span class="stringliteral">&quot;RETURN @ &quot;</span><a class="code" href="dr__defines_8h.html#a176e4c39a833f4d01f0ecd322c0f4343">PFX</a><span class="stringliteral">&quot; to &quot;</span><a class="code" href="dr__defines_8h.html#a176e4c39a833f4d01f0ecd322c0f4343">PFX</a><span class="stringliteral">&quot;\n&quot;</span>, instr_addr, target_addr);</div>
<div class="line">}</div>
<div class="ttc" id="adr__defines_8h_html_a176e4c39a833f4d01f0ecd322c0f4343"><div class="ttname"><a href="dr__defines_8h.html#a176e4c39a833f4d01f0ecd322c0f4343">PFX</a></div><div class="ttdeci">#define PFX</div><div class="ttdef"><b>Definition:</b> dr_defines.h:638</div></div>
<div class="ttc" id="adr__ir__utils_8h_html_a9e348b2596b8750ce3fad234ab022ced"><div class="ttname"><a href="dr__ir__utils_8h.html#a9e348b2596b8750ce3fad234ab022ced">dr_get_mcontext</a></div><div class="ttdeci">DR_API bool dr_get_mcontext(void *drcontext, dr_mcontext_t *context)</div></div>
<div class="ttc" id="adr__tools_8h_html_a317a1bb4c01ab9e6e64d2644d0ea984c"><div class="ttname"><a href="dr__tools_8h.html#a317a1bb4c01ab9e6e64d2644d0ea984c">dr_get_current_drcontext</a></div><div class="ttdeci">DR_API void * dr_get_current_drcontext(void)</div></div>
<div class="ttc" id="adr__tools_8h_html_ae338685a241cfeae5f3d507ae9cff957"><div class="ttname"><a href="dr__tools_8h.html#ae338685a241cfeae5f3d507ae9cff957">dr_fprintf</a></div><div class="ttdeci">DR_API ssize_t dr_fprintf(file_t f, const char *fmt,...)</div></div>
<div class="ttc" id="astruct__dr__mcontext__t_html"><div class="ttname"><a href="struct__dr__mcontext__t.html">_dr_mcontext_t</a></div><div class="ttdef"><b>Definition:</b> dr_defines.h:885</div></div>
</div><!-- fragment --><p>The address of the instruction and the address of its target are both provided. These routines could perform some sort of analysis based on these addresses. In our example we simply print out the data.</p>
<h2><a class="anchor" id="sec_ex3"></a>
Modifying Existing Instrumentation</h2>
<p>In this example, we show how to update or replace existing instrumentation after it executes. This ability is useful for clients performing adaptive optimization. In this example, however, we are interested in recording the direction of all conditional branches, but wish to remove the overhead of instrumentation once we've gathered that information. This code could form part of a dynamic CFG builder, where we want to observe the control-flow edges that execute at runtime, but remove the instrumentation after it executes.</p>
<p>While DynamoRIO supports direct fragment replacement, another method for re-instrumentation is to flush the fragment from the code cache and rebuild it in the basic block event callback. In other words, we take the following approach:</p>
<ol type="1">
<li>In the basic block event callback, insert separate instrumentation for the taken and fall-through edges.</li>
<li>When the basic block executes, note the direction taken and flush the fragment from the code cache.</li>
<li>When the basic block event triggers again, insert instrumentation only for the unseen edge. After both edges have triggered, remove all instrumentation for the cbr.</li>
</ol>
<p>We insert separate clean calls for the taken and fall-through cases. In each clean call, we record the observed direction and immediately flush the basic block using <a class="el" href="dr__tools_8h.html#a5b02f80af80dcd6005bf6c70ae7e7ad7">dr_flush_region()</a>. Since that routine removes the calling block, we redirect execution to the target or fall-through address with <a class="el" href="dr__ir__utils_8h.html#ac3aa7797e4e3ce2f741f99712bb704f5">dr_redirect_execution()</a>. The file <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/cbr.c">cbr.c</a> contains the full code for this sample.</p>
<h2><a class="anchor" id="sec_ex4"></a>
Optimization</h2>
<p>For the next example we consider a client application for a simple optimization. The optimizer replaces every increment/decrement operation with a corresponding add/subtract operation if running on a Pentium 4, where the add/subtract is less expensive. For optimizations, we are less concerned with covering all the code that is executed; on the contrary, in order to amortize the optimization overhead, we only want to apply the optimization to hot code. Thus, we apply the optimization at the trace level rather than the basic block level. Full code for this example is in the file <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/inc2add.c">inc2add.c</a>.</p>
<h2><a class="anchor" id="sec_ex5"></a>
Custom Tracing</h2>
<p>This example demonstrates the custom tracing interface. It changes DynamoRIO's tracing behavior to favor making traces that start at a call and end right after a return. It demonstrates the use of both custom trace API elements :</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> query_end_trace(<span class="keywordtype">void</span> *drcontext, <span class="keywordtype">void</span> *trace_tag, <span class="keywordtype">void</span> *next_tag);</div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="dr__tools_8h.html#a15aa23aae4a1d322fbe0a1cffedbaf3a">dr_mark_trace_head</a>(<span class="keywordtype">void</span> *drcontext, <span class="keywordtype">void</span> *tag);</div>
<div class="ttc" id="adr__tools_8h_html_a15aa23aae4a1d322fbe0a1cffedbaf3a"><div class="ttname"><a href="dr__tools_8h.html#a15aa23aae4a1d322fbe0a1cffedbaf3a">dr_mark_trace_head</a></div><div class="ttdeci">DR_API bool dr_mark_trace_head(void *drcontext, void *tag)</div></div>
</div><!-- fragment --><p>Full code for this example is in the file <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/inline.c">inline.c</a>.</p>
<h2><a class="anchor" id="sec_ex6"></a>
Use of x87 Floating Point Operation in a Client</h2>
<p>Because saving the x87 floating point state is very expensive, on x86 DynamoRIO seeks to do so on an as needed basis. If a client wishes to use floating point operations and is unsure whether its compiler will use x87 or not, or if it wishes to use MMX registers, it must save and restore the application's floating point state around the usage. For an inserted clean call out of the code cache, this can be conveniently done using <a class="el" href="dr__ir__utils_8h.html#a1df44dbe3d8dbf82e63e96741f167c64">dr_insert_clean_call()</a> and passing true for the save_fpstate parameter. It can also be done explicitly using these routines:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="dr__proc_8h.html#a48ca3205c37d6e41d007ac54a1d60e6a">proc_save_fpstate</a>(<span class="keywordtype">byte</span> *buf);</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="dr__proc_8h.html#aacb849daecc3021e451d9441b26cc814">proc_restore_fpstate</a>(<span class="keywordtype">byte</span> *buf);</div>
<div class="ttc" id="adr__proc_8h_html_a48ca3205c37d6e41d007ac54a1d60e6a"><div class="ttname"><a href="dr__proc_8h.html#a48ca3205c37d6e41d007ac54a1d60e6a">proc_save_fpstate</a></div><div class="ttdeci">DR_API size_t proc_save_fpstate(byte *buf)</div></div>
<div class="ttc" id="adr__proc_8h_html_aacb849daecc3021e451d9441b26cc814"><div class="ttname"><a href="dr__proc_8h.html#aacb849daecc3021e451d9441b26cc814">proc_restore_fpstate</a></div><div class="ttdeci">DR_API void proc_restore_fpstate(byte *buf)</div></div>
</div><!-- fragment --><p>These routines must be used if x87 floating point operations are performed in non-inserted-call locations, such as event callbacks. Note that there are restrictions on how these methods may be called: see the documentation in the header files for additional information. Note also that the floating point state must be saved around calls to our provided printing routines when they are used to print floats. However, it is not necessary to save and restore the floating point state around floating point operations if they are being used in the initialization or termination routines.</p>
<p>On ARM and AArch64 the SIMD/FP registers are always saved, so proc_save_fpstate and proc_restore_fpstate are no-ops. On x86, modern compilers typically do not use x87 operations, but to be safe clients are still advised to either avoid floating-point operations or use the preservation routines listed here.</p>
<p>This example client counts the number of basic blocks processed and keeps statistics on their average size using floating point operations. Full code for this example is in the file <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/bbsize.c">bbsize.c</a>.</p>
<h2><a class="anchor" id="sec_drstats"></a>
Use of Custom Client Statistics with the Windows GUI</h2>
<p>The new Windows GUI will display custom client statistics, if they are placed in shared memory with a certain name. The sample <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/stats.c">stats.c</a> gives code for the protocol used in the form of a sample client that counts total instructions, floating-point instructions, and system calls.</p>
<p>Note that the stats.c example client and the Windows GUI must both be run within the same session in order for the statistics to be shared properly. They can be modified to use a "Global" prefix instead of "Local" for cross-session sharing, though this requires running with administrative privileges.</p>
<h2><a class="anchor" id="sec_ex8"></a>
Use of Standalone API</h2>
<p>The binary tracedump reader also functions as an example of <a class="el" href="page_standalone.html">Disassembly Library</a> : <a href="https://github.com/DynamoRIO/dynamorio/tree/master/api/samples/tracedump.c">tracedump.c</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 11.91.20499 --- Sun Feb 15 2026 04:13:09 &nbsp; <img border=0 src="favicon.png">
</small></address>
